name: Sync docs to Wiki

on:
    push:
        branches:
            - main
        paths:
            - "docs/**"

jobs:
    sync-wiki:
        name: Generate Wiki from docs
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Configure Git identity
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

            - name: Prepare wiki repository
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                set -e
                REPO="${GITHUB_REPOSITORY}"
                WIKI_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.wiki.git"

                echo "Checking if wiki repository exists: ${WIKI_URL}"
                if git ls-remote "$WIKI_URL" > /dev/null 2>&1; then
                  echo "Wiki repository exists, cloning..."
                  git clone "$WIKI_URL" wiki
                else
                  echo "Wiki repository not found."
                  echo "Make sure the Wiki feature is enabled for this repo,"
                  echo "and create an initial page via the GitHub UI to initialize the wiki."
                  echo "Skipping wiki sync."
                  # Create empty wiki directory so later steps don't fail, but exit successfully
                  mkdir -p wiki
                  exit 0
                fi

            - name: Sync docs into wiki
              run: |
                  mkdir -p wiki
                  rsync -av --delete docs/ wiki/

            - name: Commit and push wiki changes
              working-directory: wiki
              run: |
                  if git status --porcelain | grep .; then
                    git add .
                    git commit -m "Sync docs to wiki from docs folder"
                    git push
                  else
                    echo "No wiki changes to commit"
                  fi
